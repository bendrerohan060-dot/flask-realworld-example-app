name: Python CI – Real Parallel Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Python (legacy compatible)
      - name: Set up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      # 3️⃣ Upgrade pip
      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # 4️⃣ Install ALL required dependencies (fixed versions)
      - name: Install dependencies
        run: |
          python -m pip install \
            Flask==1.1.4 \
            Werkzeug==1.0.1 \
            Jinja2==2.11.3 \
            MarkupSafe==1.1.1 \
            Flask-SQLAlchemy==2.2 \
            SQLAlchemy==1.1.9 \
            Flask-Migrate==2.7.0 \
            Flask-Bcrypt==0.7.1 \
            Flask-Caching==1.10.1 \
            Flask-Cors==3.0.10 \
            Flask-JWT-Extended==3.25.1 \
            PyJWT==1.7.1 \
            marshmallow==2.21.0 \
            apispec==3.3.2 \
            flask-apispec==0.8.8 \
            webargs==5.5.3 \
            unicode-slugify==0.1.5 \
            psycopg2-binary==2.9.9 \
            WebTest==2.0.35 \
            factory-boy==2.12.0 \
            Faker \
            pytest \
            pytest-xdist

      # 5️⃣ Run tests in REAL parallel (SCALABILITY PROOF)
      - name: Run tests in parallel
        run: |
          python -m pytest -n 3 tests/
